% REVISÃO DE LITERATURA--------------------------------------------------------

\chapter{REVISÃO TEÓRICA}
\label{chap:fundamentacaoTeorica}

Este capítulo aborda alguns conceitos dos principais componentes e ferramentas utilizadas, bem como a especificação do projeto.

\section{PROJETO ARQUITETÔNICO}
\label{sec:matrizLed}

O projeto arquitetônico definiu a quantidade e a disposição de cada objeto. Ao todo, são 128 sensores e 129 pontos de luz, dispostos sob um tampo acrílico de 1m de diâmetro, conforme apresentado na \autoref{fig:tampo}.

\begin{figure}[H]
    \centering
    \caption{Disposição dos objetos na Mesa de Bolinhas}
    \includegraphics[width=0.8\textwidth]{./dados/figuras/tampo}
    \fonte{MITSUKO, 2016}
    \label{fig:tampo}
\end{figure}

A arquiteta também especifica que o funcionamento da mesa deve ser orientado a eventos, provenientes das seções Controle e Matriz (\autoref{fig:mesa-sup}):

\begin{itemize}[noitemsep]
    \item A mesa sai do modo ocioso ao manter-se a mão sobre a bolinha \emph{Power} por mais de 1s: acende-se o seletor de cores e a mesa passa a interpretar os demais comandos;
    \item Escolhe-se uma cor ao manter-se a mão sobre uma determinada bolinha do seletor de cores por mais de 1s;
    \item Ao passar a mão sobre uma determinada bolinha da seção Matriz, a mesma deve responder com a última cor escolhida;
    \item Uma bolinha da seção Matriz pode ser apagada se a ``cor'' escolhida tiver sido a da bolinha \emph{Power};
    \item Ao manter-se a mão por mais de 3s sobre a bolinha \emph{Power}, todas as bolinhas da seção Matriz devem ser apagadas; e
    \item Ao manter-se a mão por mais de 5s sobre a bolinha \emph{Power}, a mesa entra em modo ocioso: as bolinhas do seletor de cores são apagadas e a mesa passa a ignorar os comandos sobre a Matriz.
\end{itemize}

A partir da especificação acerca do funcionamento, notam-se alguns desafios do ponto de vista do eletrônico/lógico, tais como:

\begin{itemize}
    \item A disposição dos objetos e o tamanho da mesa;
    \item A capacidade de comandar individualmente 129 \emph{LEDs} coloridos (\emph{RGB}), ou seja $129 \times 3 = 387$ canais de cor;
    \item A capacidade de interpretar os níveis lógicos dos 128 sensores;
    \item A capacidade de responder, simultaneamente, aos comandos temporais provenientes de cada sensor.
\end{itemize}

A seleção dos componentes e das ferramentas foi baseada na especificação e nos desafios acima citados, e será discutida a seguir nas demais seções deste capítulo.

\section{SENSOR}
\label{sec:sensor}

A função do sensor é identificar a posição de um objeto, no caso, a mão do espectador, sobre o tampo acrílico, e para manter-se centrado nos objetivos do projeto arquitetônico, a definição do tipo de sensor foi baseada em dois pontos essenciais:

\begin{enumerate}[label=\Roman*.]
    \item O elemento principal do projeto é a luz que flui da bolinha de \emph{ping-pong};
    \item A exposição pode ser levada a diversos lugares e ser instalada nos mais variados ambientes, como museus, escolas, saguões e etc.
\end{enumerate}

A questão (I) implica que o sensor não deve irradiar ondas eletromagnéticas dentro do espectro visível, que vai de $400nm$ a $700nm$ \cite{fundafisica}. Já a questão (II) implica que a instalação será submetida a locais com diferentes graus de iluminação, portanto os sensores devem ser imunes à variação luminosa do ambiente.

Assim sendo, optou-se pelo sensor óptico reflexivo \emph{TCRT5000L}, apresentado na \autoref{fig:sensor}, cujas características relevantes para o projeto são apresentadas na \autoref{tab:sensor}.

\begin{figure}[H]
    \centering
    \caption{Sensor TCRT5000}
    \includegraphics[width=0.24\textwidth]{./dados/figuras/sensor}
    \fonte{\citeonline{datasheet-sensor}}
    \label{fig:sensor}
\end{figure}

\input{./dados/tabelas/sensor}

Trata-se de um sensor reflexivo infravermelho ($\lambda_{P}$), ou seja, opera fora do espectro visível, o que contorna a implicação da questão (I) apresentada anteriormente. Além disso, diferentemente de um sensor passivo, por exemplo um LDR, o TCRT5000 opera irradiando luz e, ademais, também contém filtro óptico embutido, absorvendo somente comprimentos de onda próximas a ($\lambda_{P}$). Essa duas características contornam a implicação da questão (II).

A saída transistorizada permite que o sensor seja interpretado de forma lógica. Sua aplicação (\autoref{fig:sensoraplicacao}) vai desde sensoriamento de \emph{encoders} e posições de ``fim de curso'' até detecção de papéis, cartões, fitas e etc. Foi escolhida a variante ``L'' (\emph{TCRT5000\textbf{L}}) por ser a versão com terminais estendidos.

\begin{figure}[H]
    \centering
    \caption{Aplicação do sensor TCRT5000}
    \includegraphics[width=0.5\textwidth]{./dados/figuras/sensor-op}
    \fonte{\citeonline{datasheet-sensor}}
    \label{fig:sensoraplicacao}
\end{figure}

\section{REGISTRADORES DE DESLOCAMENTO}
\label{sec:registradores}

A necessidade de interpretar individualmente os 128 sensores implica na mesma quantidade de entradas do circuito de processamento. Então, optou-se por lidar com entradas virtuais, através de um barramento serial, por meio de registradores de deslocamento. Dessa forma, com poucas GPIOs, o microcontrolador pode interpretar os níveis lógicos de todos os sensores conectados ao barramento.

Devido sua grande difusão no mercado, o registrador de deslocamento escolhido foi o 74HC165. A \autoref{fig:shift-register} apresenta o diagrama funcional do circuito integrado.

\begin{figure}[H]
    \centering
    \caption{Diagrama funcional do 74HC165}
    \includegraphics[width=0.5\textwidth]{./dados/figuras/shift-register}
    \fonte{\citeonline{datasheet-shift-register}}
    \label{fig:shift-register}
\end{figure}

Trata-se de um registrador de deslocamento com 8 entradas em paralelo ($D_{N}$) e saídas complementares ($Q_{7}$ e $\overline{Q_{7}}$) em serial. Basicamente, seu funcionamento (\autoref{fig:shift-temporal}) constitui-se na captura instantânea do nível lógico de suas entradas (borda de descida da Entrada Assíncrona de Carga Paralela, $\overline{P_{L}}$) e na transmissão desses valores através de deslocamento ordenado ($D_{7} \rightarrow D_{0}$) na saída serial ($Q_{7}$), nos eventos de borda de subida na entrada de \emph{clock} ($C_{P}$).

\begin{figure}[!htb]
    \centering
    \caption{Diagrama temporal do 74HC165}
    \includegraphics[width=0.6\textwidth]{./dados/figuras/shift-temporal}
    \fonte{\citeonline{datasheet-shift-register}}
    \label{fig:shift-temporal}
\end{figure}

\section{DEBOUNCE}
\label{sec:debounce}

Embora o funcionamento do sensor (\autoref{sec:sensor}) seja aparentemente simples - isto é, o transistor vai à saturação ao detectar um objeto; ou o transistor permanece em corte se não houver detecção - podem haver disparos falsos devido à oscilação do sinal durante a interação com a mesa. Essa oscilação é conhecida como \emph{bouncing}: trepidação do nível lógico durante a mudança de estado. A \autoref{fig:switch-bounce} apresenta um exemplo dessa oscilação, quando uma chave física passou do nível lógico alto para o baixo, ao ser pressionada.

\begin{figure}[H]
    \centering
    \caption{Oscilação do sinal de uma chave sendo pressionada}
    \includegraphics[width=0.6\textwidth]{./dados/figuras/bounce}
    \fonte{\citeonline{switch-debounce}}
    \label{fig:switch-bounce}
\end{figure}

Ainda que a Mesa de Bolinhas não conte com botões físicos, o efeito \emph{bouncing} pode vir a ocorrer em razão do limiar de detecção do sensor: o transistor de saída pode ficar operando, ainda que brevemente, no limite da interpretação do seu nível lógico. Para contornar tal situação, assim como nos casos de chaves físicas, será implementado um procedimento de \emph{debouncing}. \citeonline{debounceguide} cita diversas técnicas, desde descarte de tempo, filtros RC (resistor e capacitor), técnicas com \emph{latches} (\autoref{fig:srdebouncer}), entre outros, inclusive via \emph{software}.

\begin{figure}[H]
    \centering
    \caption{Exemplo de circuito de \emph{debounce} com \emph{latches}}
    \includegraphics[width=0.4\textwidth]{./dados/figuras/srdebouncer}
    \fonte{\citeonline{debounceguide}}
    \label{fig:srdebouncer}
\end{figure}

No caso da Mesa de Bolinhas, não conviria implementar os modelos de  \emph{debouncing} por \emph{hardware}, pois implicaria diretamente no custo do projeto, não só pelo custo dos componentes, mas também pela área de placa ocupada, e também na complexidade do leiaute da PCI. Então, optou-se por implementar uma técnica de contorno via \emph{firmware}. Com isso, não há necessidade de adicionar componentes auxiliares ao circuito dos sensores e registradores de deslocamento. Trata-se de uma técnica baseada em ``histerese temporal'', onde a referência virtual altera-se de estado somente quando o nível de seu respectivo sensor já estiver estabilizado durante N milissegundos. A implementação dessa técnica será desenvolvida no \autoref{chap:metodologia}.

%\section{TECLADO ADC}
%\label{sec:tecladoAD}

\section{LED}
\label{sec:led}

Para a matriz de saída, optou-se pelo LED WS2812S (\autoref{fig:ws2812}), um dispositivo RGB em encapsulamento SMD5050, com controlador interno, o WS2811: um \emph{driver} especial para LEDs, com 3 saídas de 8 \emph{bits} de resolução, ou seja, pode-se gerar até 16777216 cores do formato RGB. Esse controlador é muito utilizado em fitas de LEDs endereçáveis (\autoref{fig:strip}), por permitir a conexão de vários controladores em um mesmo barramento serial (protocolo NRZ), podendo-se controlar cada LED individualmente.

O fato de possuir um controlador embutido no próprio encapsulamento implica diretamente sobre o valor do LED, custando um pouco mais que o dobro do valor médio de outros LEDs RGBs mais simples. Apesar disso, o custo acaba sendo compensado pelos benefícios que o \emph{driver} proporciona.

\begin{figure}[!htb]
    \centering
    \caption{Vista aproximada do LED WS2812 e seu controlador interno}
    \includegraphics[width=0.65\textwidth]{./dados/figuras/ws2812}
    \fonte{\citeonline{adafruit}}
    \label{fig:ws2812}
\end{figure}

O modelo do LED já havia sido selecionada durante o Programa de Iniciação Científica que o autor participou, já sendo utilizado no circuito da matriz. No projeto aqui proposto, eles serão utilizados no seletor de cores, discutido no \autoref{chap:metodologia}.

\begin{figure}[!htb]
    \centering
    \caption{Fita de LED endereçável utilizando o WS2812}
    \includegraphics[width=0.5\textwidth]{./dados/figuras/strip}
    \fonte{\citeonline{adafruit}}
    \label{fig:strip}
\end{figure}



\textcolor{red}{TODO: esquema de cores}
\textcolor{red}{TODO: consumo}
\textcolor{red}{TODO: protocolo NRZ}

\section{BAKER CLAMP}
\label{sec:backerclamp}

Segundo \citeonline{theartofelectronics}, os mesmos efeitos que limitam o desempenho de amplificadores lineares em altas frequências (a combinação de capacitância de junção, capacitância de retorno e capacitância parasita) também impõem limitações de velocidade em circuitos digitais de alta frequência. A \autoref{fig:tjb} apresenta um amplificador ``emissor comum'', que pode atuar como uma chave inversora quando operado em corte e saturação, alimentado por uma fonte de pulsos com tempos de subida e descida extremamente curtos, e a \autoref{fig:curvatjb} apresenta uma curva típica desse tipo de amplificador ao considerar as componentes parasitas. 

\begin{figure}[H]
    \centering
    \caption{Representação de uma chave inversora com TJB}
    \includegraphics[width=0.45\textwidth]{./dados/figuras/tjb}
    \fonte{\cite{theartofelectronics}}
    \label{fig:tjb}
\end{figure}

\begin{figure}[H]
    \centering
    \caption{Forma de onda da chave inversora com TJB}
    \includegraphics[width=0.6\textwidth]{./dados/figuras/curvatjb}
    \fonte{\cite{theartofelectronics}}
    \label{fig:curvatjb}
\end{figure}

Nota-se que, assim que a fonte estabelece o pulso em nível baixo, o transistor leva um certo tempo ($t_r$) para sair da saturação e entrar em corte. Esse comportamento deriva-se do acúmulo de carga ($C_{cb}$) entre o coletor e a base. Dependendo das características físicas do transistor e da aplicação, esse tempo de subida pode vir a prejudicar o desempenho da finalidade do circuito, como é o caso do conversor de nível lógico elaborado para a Mesa de Bolinhas (discutido no \autoref{chap:metodologia}).

Para mitigar tal efeito, \citeonline{theartofelectronics} propõem a inclusão de um diodo de \emph{clamping} (``Baker clamp''), entre a base e o coletor do TJB (\autoref{fig:bakerclamp}). Esse diodo irá desviar a corrente de base quando o transistor estiver se aproximando da saturação e evitará sua saturação, uma vez que a queda direta de tensão do diodo, no caso um diodo Schottky, é menor que a da junção coletor-base. Dessa forma, o TJB pode entrar em corte mais rapidamente, pois o mesmo não chega a entrar no ponto de saturação profunda.

\begin{figure}[H]
    \centering
    \caption{Chave inversora com o diodo de ``Baker \emph{clamping}''}
    \includegraphics[width=0.25\textwidth]{./dados/figuras/bakerclamp}
    \fonte{\cite{theartofelectronics}}
    \label{fig:bakerclamp}
\end{figure}

\section{MICROCONTROLADOR}
\label{sec:microcontrolador}

O ESP8266 é o microcontrolador de entrada para a família de 32 bits da fabricante chinesa Espressif Systems. Produzido em escala a partir de 2014, essa família ganhou espaço na área de Internet das Coisas por ser um microcontrolador de baixo custo, de baixo consumo e com suporte à rede 802.11 (\emph{Wi-Fi}). A \autoref{tab:espec-microcontrolador} apresenta as principais especificações do microcontrolador e a \autoref{fig:esp-funcional} apresenta seu diagrama funcional. Cabe aqui ressaltar que toda a parte de radio-frequência é implementada por \emph{hardware}, simplificando o desenvolvimento de aplicações com comunicação sem fio.

\input{./dados/tabelas/microcontrolador}

\begin{figure}[!htb]
    \centering
    \caption{Diagrama funcional do ESP8266}
    \includegraphics[width=0.9\textwidth]{./dados/figuras/esp-funcional}
    \fonte{\citeonline{datasheet-esp}}
    \label{fig:esp-funcional}
\end{figure}

Embora a comunicação sem fio não fizesse parte das especificações do projeto arquitetônico original, a equipe concordou com a possibilidade de implementá-la em uma aplicação futura. Esse foi o ponto decisivo para a escolha do ESP8266. Assim, a Mesa de Bolinhas poderá ganhar novas funcionalidades sem haver a necessidade de alteração no \emph{hardware}. Isso será discutido na \autoref{sec:trabalhosFuturos}.

Entre os diversos módulos que incluem o ESP8266, optou-se pelo ESP-12, por ser o que dispõe a maior quantidade de GPIOs (9 ao todo). A \autoref{fig:esp-12} apresenta sua placa. Convém salientar que este módulo já conta com memória \emph{Flash} (4MB) e antena \emph{microstrip}.

\begin{figure}[H]
    \centering
    \caption{Módulo ESP-12}
    \includegraphics[width=0.4\textwidth]{./dados/figuras/esp-12}
    \fonte{\cite{book-esp}}
    \label{fig:esp-12}
\end{figure}

Por serem compartilhados entre aplicações do usuário e funcionalidades internas, alguns pinos possuem certas particularidades. Os resistores  \emph{pull-up/pull-down} (\autoref{fig:esp-12}) garantem o nível lógico de alguns pinos, porém outros necessitam de uma atenção especial, sobretudo os que definem o modo de funcionamento: operação normal ou modo de gravação, que será discutido no \autoref{chap:metodologia}. A \autoref{tab:pinoutesp} apresenta a pinagem do módulo ESP-12 e também a função interna cada pino.

\input{./dados/tabelas/pinoutesp}

\section{\emph{FRAMEWORK}}
\label{sec:framework}

Sming é um \emph{framework} de código aberto, nativo para a família de microcontroladores ESP8266, desenvolvido na linguagem {C++} e com foco em alta eficiência em desempenho e em uso de memória.

Diferente de outros \emph{frameworks} baseados em laço-infinito, a estrutura do Sming é baseada em eventos temporais: as tarefas do usuário são escaladas em uma tabela de tempo. Isso o aproxima de uma das funcionalidades de um Sitema Operacional de Tempo Real, embora não haja, obviamente, um gerenciamento de recursos. Porém, o fato de poder-se escalar as tarefas em uma janela de tempo simplifica a implementação da especificação deste projeto, uma vez que, basicamente, sua funcionalidade também é baseada em eventos temporais, como apresentado no começo do capítulo (\autoref{sec:matrizLed}).

Por tratar-se de uma plataforma de código aberto, este \emph{framework} conta com uma vasta contribuição da comunidade, com uma API de \emph{hardware} robusta e diversas bibliotecas nativas, tais como \emph{bootloader}, sistema de arquivos (SPIFFS), atualização sem fio de \emph{firmware} (OTA) e uma extensa pilha assíncrona de rede (TCP, UDP, \emph{WebSockets} e etc). Esses recursos são úteis para a continuidade do projeto, discutida na \autoref{sec:trabalhosFuturos}.
